=begin
  ebounty.lic - attempting to consolidate bounty tasks under one script

        author: elanthia-online
  contributers: Deysh, Nisugi, Tysong, Rinualdo
          game: Gemstone
          tags: bounty
       version: 1.0.0
           
  Improvements:

  v1.0.0 (2022-05-18)
    - initial framework and ui
=end

require "yaml"

module EBounty

  EBounty_version = '1.0.0'
  @@data ||= nil
 
   ##### Data & Setup Start #####
  
  def self.version_check
  
    # Check version of Lich for compatibility
    lich_gem_requires = '5.4.1'
    infomon_gem_requires = '1.18.11'
    infomon_version = '0.0.0'
    infomon_data = open("#{SCRIPT_DIR}/infomon.lic", 'r').read
    if infomon_data =~ /^=begin\r?\n?(.+?)^=end/m
        comments = $1.split("\n")
    else
        comments = []
        infomon_data.split("\n").each {|line|
            if line =~ /^[\t\s]*#/
                comments.push(line)
            elsif line !~ /^[\t\s]*$/
                break
            end
        }
    end
    for line in comments
        if line =~ /^[\s\t#]*version:[\s\t]*([\w,\s\.\d]+)/i
            infomon_version = $1.sub(/\s\(.*?\)/, '').strip
        end
    end

    if Gem::Version.new(LICH_VERSION) < Gem::Version.new(lich_gem_requires) || Gem::Version.new(infomon_version) < Gem::Version.new(infomon_gem_requires)
       if $frontend == 'stormfront' || $frontend == 'profanity'
         _respond "\<preset id=\"speech\"\>" + "########################################" + "\<\/preset\>"
         _respond "\<preset id=\"thought\"\>" + "Script: #{Script.self} now requires a newer version of Lich(#{lich_gem_requires}+) & Infomon (#{infomon_gem_requires}) to run." + "\<\/preset\>"
         _respond "\<preset id=\"thought\"\>" + "Please update to a newer version." + "\<\/preset\>"
         _respond ""
         _respond "\<preset id=\"thought\"\>" + "Currently Running Lich Version: #{Gem::Version.new(LICH_VERSION) }" + "\<\/preset\>"
         _respond "\<preset id=\"thought\"\>" + "Currently Running Infomon Version: #{Gem::Version.new(infomon_version) }" + "\<\/preset\>"
         _respond "\<preset id=\"thought\"\>" + "For help updating visit: https://gswiki.play.net/Lich_(software)/Installation" + "\<\/preset\>"
         _respond "\<preset id=\"speech\"\>" + "########################################" + "\<\/preset\>"
       else
         _respond "##" + "########################################"
         _respond ">" + "Script: #{Script.name} now requires a newer version of Lich(#{lich_gem_requires}+) & Infomon (#{infomon_gem_requires}) to run."
         _respond ">" + "Please update to a newer version."
         _respond ">" + ""
         _respond ">" + "Currently Running Lich Version: #{Gem::Version.new(LICH_VERSION) }"
         _respond ">" + "Currently Running Infomon Version: #{Gem::Version.new(infomon_version) }"
         _respond ">" + "For help updating visit: https://gswiki.play.net/Lich_(software)/Installation"
         _respond "##" + "########################################"
       end
       exit
    end
  
  end
  
  def self.load_defaults()
    
    default_hash = {
      :bounty_types=>["boss_creature", "culling", "gem_collecting", "heirloom_loot", "skinning"],
      :selling_script=>"",
      :default_profile=>"",
      
    }
    Dir.mkdir("#{$data_dir}#{XMLData.game}") unless File.exist?("#{$data_dir}#{XMLData.game}")
    Dir.mkdir("#{$data_dir}#{XMLData.game}/#{Char.name}") unless File.exist?("#{$data_dir}#{XMLData.game}/#{Char.name}")
    Dir.mkdir("#{$data_dir}#{XMLData.game}/#{Char.name}/bigshot_profiles") unless File.exist?("#{$data_dir}#{XMLData.game}/#{Char.name}/bigshot_profiles")

    File.write("#{$data_dir}#{XMLData.game}/#{Char.name}/ebounty.yaml", default_hash.to_yaml)
   
    default_hash
  end

  def self.load_profile(name: Char.name)
    if name != nil
      filename = "#{$data_dir}#{XMLData.game}/#{name}/ebounty.yaml"
      if File.exist?("#{filename}") && name == Char.name
        settings_hash = YAML.load_file(filename)      
      elsif !File.exist?("#{filename}") && name != Char.name
        EBounty.msg("error", " EBounty.load_profile: Attempt to load a profile that does not exist.")
      elsif !File.exist?("#{filename}") && name == Char.name
        EBounty.msg("info", " No current settings found.  Loading defaults for configurtion.")
        EBounty.msg("info", " Suggest you configure to your needs with ;ebounty setup")
        settings_hash = EBounty.load_defaults()
      else
        EBounty.msg("error", " EBounty.load_profile: There was an unknown error with loading a profile")
      end
    else
      EBounty.msg("error", " EBounty.load_profile: name not defined")
    end
 
    settings_hash
    
  end

  def self.save_profile(name: Char.name)
    
    #This adds it to the profile for backward compatability
    if name != nil
      filename = "#{$data_dir}#{XMLData.game}/#{Char.name}/ebounty.yaml"
      if name == Char.name
        File.write(filename, EBounty.data.settings.to_yaml)
        EBounty.msg("info", " Settings saved to file: #{filename}.")
      elsif File.exist?("#{filename}") && name != Char.name
        EBounty.msg("info", " You are attempt to overwrite another profile!")
        EBounty.msg("info", " If you wish to overwrite, please ;unpause ebounty.")
        EBounty.msg("info", " Else ;kill ebounty and choose another filename.")
        pause_script
        File.write(filename, EBounty.data.settings.to_yaml)
        EBounty.msg("info", " Settings saved to file: #{filename}.")        
      elsif !File.exist?("#{filename}") && name != Char.name
        File.write(filename, EBounty.data.settings.to_yaml)
        EBounty.msg("info", " Settings are being saved to another profile!")
        EBounty.msg("info", " Settings saved to file: #{filename}.")
      else
        EBounty.msg("error", " EBounty.save_profile: There was an unknown error with saving a profile")
      end
    end
       
  end

  def self.load(settings)
    @@data = Data.new(settings)
  end

  def self.data
    @@data
  end

  def self.set_variables
  
    #Check if a default profile was selected
    if EBounty.data.settings[:default_profile].to_s.empty?
      ELoot.msg "error", 'Please select a profile in "The Rest" tab as a default. Ebounty needs this to work right. Exiting...'
      exit
    end
     
    #Load the default profile
    profile = "#{EBounty.data.dir}/#{EBounty.data.settings[:default_profile]}.yaml"
    UserVars.op = YAML.load_file(profile)
  
    #Lets find the containers we need
    container_match = /<a exist="([^"]+)" noun="[^"]+">[^(.]+\(([a-z]+)\)/
    container_lines = Lich::Util.quiet_command_xml("stow list",/<output class="mono"\/>/)  

    container_lines.each {|line|   
      if line =~ container_match 
        EBounty.data.sacks.store(Regexp.last_match(2), GameObj.inv.find { |i| i.id == Regexp.last_match(1) })
        EBounty.data.sacks.delete(Regexp.last_match(2)) unless EBounty.data.sacks[Regexp.last_match(2)]    
      end
    }
       
  end

  def self.bounty_check
    Task.bounty_check
  end
 
  def self.msg(type = info, text)
     
    #color options - set type to use
    #yellow, orange, teal, green, plain
       
    return if type == "debug" && !EBounty.data.settings[:debug]
       
    if text.class == Hash
      text = text.inspect.gsub("#<", "#")
    elsif text.class == Array
      text = text.to_s
    elsif text.class == String
      text = text.gsub("#<", "#")
    end
    
    type = type == "debug" ? "speech" : type
    
    Lich::Messaging.msg(type, text)
  
  end

  def self.skinning_profile(critter = nil, no_skin = false)
    
    if (EBounty.data.settings[:creature_exclude].length.positive? && critter =~ Regexp.union(EBounty.data.settings[:creature_exclude]))
      echo "#{critter} is in the excluded list. Turning in bounty!"
      sleep 2
      Task.bounty_remove
      return
    end  
 
    EBounty.data.creature = critter
    load_profile = nil
    from_file = nil
   
    dir = EBounty.data.dir
 
    Dir.foreach(dir) do |filename|
      next if filename == '.' || filename == '..' 
      found_critter = false
      close = false
     
      profile = "#{dir}/#{filename}"
      from_file = YAML.load_file(profile)
    
      if from_file["targets"].include?(critter) && (from_file["profile_skinning"] || no_skin)
        found_critter = true   
      else
        next
      end
      
       
      previous, dist = Map.dijkstra(Room[from_file["hunting_room_id"]])
      #Fixme: support for uid
      if dist[from_file["resting_room_id"].to_i] < 75
        close = true
      else
        next
      end
   
      if found_critter && close
        load_profile = filename
        break
      end
            
    end
  
    if load_profile
      UserVars.op = from_file
     # echo "Settings loaded from profile: #{load_profile}."
      
      #fixme: convert room ID's here
      
      return true
      #load profile here if it met parameters
    elsif !no_skin
      EBounty.skinning_profile(critter, true)
    else
      echo "No Profile found to skin #{critter}. Please create a Bigshot profile that uses the full name of the critter and flag it as skin. Exiting..."
      exit
    end
  
  
  end
  
  def self.switch_profile(critter = nil, location = nil)
   
    if (EBounty.data.settings[:creature_exclude].length.positive? && critter =~ Regexp.union(EBounty.data.settings[:creature_exclude]))
      echo "#{critter} is in the excluded list. Turning in bounty!"
      sleep 2
      Task.bounty_remove
      return
    end  
 
    EBounty.data.creature = critter
    load_profile = nil
    from_file = nil
 
    dir = EBounty.data.dir
 
    Dir.foreach(dir) do |filename|
     #echo filename
      next if filename == '.' || filename == '..' 
      
      found_critter = false
      found_location = false

      profile = "#{dir}/#{filename}"
      from_file = YAML.load_file(profile)
     #   echo "Room[from_file['hunting_room_id']].location: #{Room[from_file["hunting_room_id"]].location} Location: #{location}"
     #Fixme: support for uid
      if Room[from_file["hunting_room_id"]].location =~ /#{location}/i && !location.nil?
        found_location = true
      else
        next
      end
    #echo from_file["targets"].include?(critter.split.last)
      if (from_file["targets"].split(", ").include?(critter.split.last) || from_file["targets"].include?(critter)) || (from_file["profile_bandits"] && EBounty.data.creature == "bandits")
        found_critter = true
      else
        next
      end
                
      if found_location && found_critter
        load_profile = filename
        break     
      end
      
  
    end

    if load_profile
      UserVars.op = from_file  
     # echo "Settings loaded from profile: #{load_profile}."
      return true
    else
      echo "No Profile found for #{critter}. Please create a Bigshot profile. Exiting..."
      exit
    end

  end
  
  def self.test
  
    EBounty.set_variables
  exit
    # EBounty.switch_profile("dark orc","the smuggling tunnels")
    echo " Ebounty Version: #{EBounty_version}"
    echo ""
    echo "--------------- Settings ---------------"
    echo *EBounty.data.settings
    echo "----------------------------------------"
    echo ""
   
  end
  
  def self.go2(place)
    fput('unhide') if (hidden? || invisible?)

    return if Room.current.id == place || Room.current.tags.include?(place)

    if Room.current.id.nil?
      if ELoot.data.settings[:debug]
        ELoot.msg "info", "unknown room location: hope you know what you're doing"
      else
        ELoot.msg "error", 'unknown room location'
      end
    end
    Script.run('go2', "#{place} --disable-confirm", { quiet: true })
  end
  
  def self.go2_rest
  
    town_id = Room[Room[UserVars.op["resting_room_id"]].find_nearest_by_tag("town")].id 
    UserVars.op["resting_commands"].to_a.each { |i| fput(i) } unless UserVars.op["resting_commands"].empty?
    resting_spots = { 
      228 => [1259,14627,8859,1263,228,318,288,477], #town center => noded rooms
      3668 => [3668,28742,18258,17589,17587],
      1005 => [1005,14029],     
    }
  
    if resting_spots[town_id].include?(Room.current.id) || (XMLData.game == "GSF" && Room.current.id == 20239)
      return
    end
  
    if XMLData.game == "GSF" 
      where_to = 20239
    elsif XMLData.game == 'GSIV' && resting_spots[town_id]
      where_to = town_id
      where_to = resting_spots[town_id].sample if EBounty.data.settings.rest_random
    else
      where_to = "town"
    end
    
    EBounty.go2(where_to)
    EBounty.wait_rt
    
    if checkpcs.include?('Nexushealbot')
      fput "join Nexushealbot"
      fput "action just nudged you"
      sleep 15
    end
  
  end
  
  def self.silver_check  
    return Lich::Util.silver_count
  end
  
  def self.sell
  
    seller = EBounty.data.settings[:selling_script]
    if seller.nil? || seller.empty?
      Script.run('eloot', 'sell')
    else
      Script.run(seller, 'sell')
    end
  
  end
  
  def self.silver_deposit
  
    return unless EBounty.silver_check.positive? 
    
    EBounty.go2('bank') 
    fput('deposit all')  
    
  end
  
  def self.wait_rt 
    sleep 0.2
    wait_while { checkrt > 0 }
    sleep 0.2 
  end
  
  ##### Data & Setup End #####

  # Global data used by EBounty
  class Data
    attr_accessor  :settings, :reason, :rest_time, :rest_options, :lootsack, :hunting_spots, :wait, :herbalist_rooms, :remaining_skins, :skin, :remaining_gems, :gem, :dir,
                   :creature, :sacks

    def initialize(settings)
      
      @settings = settings     
      @reason = ''
      @rest_time = Time.now
      @wait = true
      @sacks = {}
      @rest_options  = ["experience", "inventory", "health", "resources", "info"]
      @herbalist_rooms = [2406, 3824, 1851, 10396, 640, 5722, 5406, 11002, 9505]
      @remaining_skins = 0
      @skin = nil
      @remaining_gems = 0
      @gem = nil
      @dir = "#{$data_dir}#{XMLData.game}/#{Char.name}/bigshot_profiles"
      @creature = nil
      
      
      if !UserVars.lootsack.nil?
        @lootsack = GameObj.inv.find do |i|
          i.noun =~ /\b#{UserVars.lootsack}\b/i or
          i.name =~ /#{UserVars.lootsack}/i
        end
      end

      if @lootsack.nil?
        respond "set \"lootsack\" before using this script: ;vars set lootsack=<item>"
        exit
      end
     
    end
  end

  class Setup < Gtk::Builder
    
    @@categories = {
      general: {
        bounty_types: { default: [] },
        escort_types: { default: [] },
        creature_exclude: {
          default: [],
          load: proc do |store, setting|
            store.clear
            setting.each do |text|
              iter = store.append
              iter[0] = text
            end
          end,
          delete: proc do |_, selected, setting|
            setting.delete(selected.get_value(0))
            setting.uniq!.sort!
          end,
          set: proc do |_, text, setting|
            next if setting.include?(text)

            setting.push(text)
            setting.uniq!.sort!
          end
        },       
        culling_max:              { default: 30 },
        gem_max:                  { default: 30 },
        herb_max:                 { default: 30 },
        skin_max:                 { default: 30 },
        extra_skin:               { default:  0 },
        exp_pause:                { default: false },
        only_required_creatures:  { default: false },
        use_vouchers:             { default: false },
        once_and_done:            { default: false },
        rest_random:              { default: false },
        selling_script:           { default: '' },
        profile_name:             { default: '' },
        default_profile:          { default: '' },
      },       
      internal: {
        silence: { default: true },
        debug: { default: false },       
      }
    }

    def self.get_category(key)
      @@categories.each { |category, data| return category unless data[key].nil? }
      nil
    end

    def self.get_setting(key)
      cat = Setup.get_category(key)
      return nil if cat.nil?

      @@categories[cat].each { |setting, data| return data if setting == key }
      nil
    end

    def initialize(settings)
      super()

      @settings = settings

      # set default values if they don't exist
      @@categories.each do |_, data|  
      
        data.each { |key, value| @settings[key] = value[:default] if @settings[key].nil? }
      end

      # remove settings that doesn't exist
      @settings.delete_if { |key, _| next Setup.get_category(key).nil? }

      # use a GTK Builder to setup all the basics of the window then expand on that base
      return unless defined?(Gtk) && Gtk::Version::MAJOR == 3

      Gtk.queue do
       # add_from_file("#{$data_dir}ebounty.ui")
        add_from_string(ui)
        load_settings

        self['main'].keep_above = true
        self['main'].set_title "EBounty Setup v#{EBounty_version}"

        # connect signals after settings are loaded to a bunch of handlers don't trigger
        connect_signals { |handler| method(handler) }
      end
    end

    def ui
      '<?xml version="1.0" encoding="UTF-8"?><!-- Generated with glade 3.38.2 --><interface><requires lib="gtk+" version="3.20"/><object class="GtkListStore" id="creature_exclude_store"><columns><!-- column-name exclusion --><column type="gchararray"/></columns></object><object class="GtkAdjustment" id="culling_adjustment"><property name="upper">100</property><property name="step-increment">1</property><property name="page-increment">10</property>
      </object><object class="GtkAdjustment" id="extra_skin_adjustment"><property name="upper">100</property><property name="step-increment">1</property><property name="page-increment">10</property></object><object class="GtkAdjustment" id="gem_adjustment"><property name="upper">100</property><property name="step-increment">1</property><property name="page-increment">10</property></object><object class="GtkAdjustment" id="herb_adjustment"><property name="upper">100</property><property name="step-increment">1</property><property name="page-increment">10</property>
      </object><object class="GtkAdjustment" id="skin_adjustment"><property name="upper">100</property><property name="step-increment">1</property><property name="page-increment">10</property></object><object class="GtkWindow" id="main"><property name="width-request">750</property><property name="height-request">600</property><property name="can-focus">False</property><property name="title" translatable="yes">EBounty Setup</property><property name="modal">True</property><signal name="destroy" handler="on_destroy" swapped="no"/><child><object class="GtkBox"><property name="visible">True</property><property name="can-focus">False</property><property name="orientation">vertical</property><property name="spacing">5</property><child><object class="GtkNotebook"><property name="visible">True</property><property name="can-focus">True</property><property name="hexpand">True</property><property name="vexpand">True</property><child><object class="GtkScrolledWindow"><property name="visible">True</property><property name="can-focus">True</property><property name="shadow-type">in</property><child><object class="GtkViewport"><property name="visible">True</property><property name="can-focus">False</property><child><object class="GtkBox"><property name="visible">True</property><property name="can-focus">False</property><property name="orientation">vertical</property><child><object class="GtkFrame"><property name="visible">True</property><property name="can-focus">False</property><property name="border-width">10</property><property name="label-xalign">0</property><child><!-- n-columns=5 n-rows=2 --><object class="GtkGrid"><property name="visible">True</property><property name="can-focus">False</property><property name="margin-top">5</property><property name="margin-bottom">5</property><property name="row-spacing">2</property><property name="column-spacing">5</property><property name="column-homogeneous">True</property><child><object class="GtkCheckButton" id="bounty_types:boss_creature"><property name="label" translatable="yes">Boss Creature</property><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">True</property><property name="halign">start</property><property name="margin-start">5</property><property name="draw-indicator">True</property>
      </object><packing><property name="left-attach">0</property><property name="top-attach">0</property></packing></child><child><object class="GtkCheckButton" id="bounty_types:culling"><property name="label" translatable="yes">Culling</property><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">True</property><property name="halign">start</property><property name="draw-indicator">True</property></object><packing><property name="left-attach">1</property><property name="top-attach">0</property>
      </packing></child><child><object class="GtkCheckButton" id="bounty_types:escort"><property name="label" translatable="yes">Escort</property><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">start</property><property name="draw-indicator">True</property></object><packing><property name="left-attach">2</property><property name="top-attach">0</property></packing></child><child><object class="GtkCheckButton" id="bounty_types:foraging"><property name="label" translatable="yes">Foraging</property><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">start</property><property name="draw-indicator">True</property>
      </object><packing><property name="left-attach">3</property><property name="top-attach">0</property></packing></child><child><object class="GtkCheckButton" id="bounty_types:gem_collecting"><property name="label" translatable="yes">Gem Collecting</property><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">True</property><property name="halign">start</property><property name="draw-indicator">True</property></object><packing><property name="left-attach">4</property><property name="top-attach">0</property>
      </packing></child><child><object class="GtkCheckButton" id="bounty_types:heirloom_loot"><property name="label" translatable="yes">Heirloom (loot)</property><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">True</property><property name="halign">start</property><property name="margin-start">5</property><property name="draw-indicator">True</property></object><packing><property name="left-attach">0</property><property name="top-attach">1</property>
      </packing></child><child><object class="GtkCheckButton" id="bounty_types:heirloom_search"><property name="label" translatable="yes">Heirloom (search)</property><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">start</property><property name="draw-indicator">True</property></object><packing><property name="left-attach">1</property><property name="top-attach">1</property></packing></child><child><object class="GtkCheckButton" id="bounty_types:kill_bandits"><property name="label" translatable="yes">Kill Bandits</property><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">start</property><property name="draw-indicator">True</property>
      </object><packing><property name="left-attach">2</property><property name="top-attach">1</property></packing></child><child><object class="GtkCheckButton" id="bounty_types:rescue"><property name="label" translatable="yes">Rescue</property><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">start</property><property name="draw-indicator">True</property></object><packing><property name="left-attach">3</property><property name="top-attach">1</property>
      </packing></child><child><object class="GtkCheckButton" id="bounty_types:skinning"><property name="label" translatable="yes">Skinning</property><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">True</property><property name="halign">start</property><property name="draw-indicator">True</property></object><packing><property name="left-attach">4</property><property name="top-attach">1</property></packing></child></object></child><child type="label"><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="label" translatable="yes">Bounty Types</property>
      </object></child></object><packing><property name="expand">False</property><property name="fill">True</property><property name="position">0</property></packing></child><child><object class="GtkFrame"><property name="visible">True</property><property name="can-focus">False</property><property name="border-width">10</property><property name="label-xalign">0</property><child><!-- n-columns=6 n-rows=2 --><object class="GtkGrid"><property name="visible">True</property><property name="can-focus">False</property><property name="margin-end">7</property><property name="margin-top">5</property><property name="margin-bottom">5</property><property name="row-spacing">5</property><property name="column-spacing">5</property><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="tooltip-text" translatable="yes">Max number of critters you\'ll kill for a culling bounty.</property><property name="halign">end</property><property name="margin-start">5</property><property name="label" translatable="yes">  Max Culling Kills (?)</property>
      </object><packing><property name="left-attach">0</property><property name="top-attach">0</property></packing></child><child><object class="GtkSpinButton" id="culling_max"><property name="visible">True</property><property name="can-focus">True</property><property name="adjustment">culling_adjustment</property><property name="numeric">True</property><property name="value">30</property></object><packing><property name="left-attach">1</property><property name="top-attach">0</property></packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="tooltip-text" translatable="yes">Max number of gems you\'re willing to find.</property><property name="halign">end</property><property name="margin-bottom">10</property><property name="label" translatable="yes">Max Gems (?)</property>
      </object><packing><property name="left-attach">0</property><property name="top-attach">1</property></packing></child><child><object class="GtkSpinButton" id="gem_max"><property name="visible">True</property><property name="can-focus">True</property><property name="margin-bottom">10</property><property name="adjustment">gem_adjustment</property><property name="numeric">True</property><property name="value">30</property></object><packing><property name="left-attach">1</property><property name="top-attach">1</property>
      </packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="label" translatable="yes">     </property></object><packing><property name="left-attach">2</property><property name="top-attach">1</property></packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="tooltip-text" translatable="yes">Max number of herbs you\'re willing to find.</property><property name="halign">end</property><property name="margin-start">20</property><property name="label" translatable="yes">Max Herbs (?)</property>
      </object><packing><property name="left-attach">2</property><property name="top-attach">0</property></packing></child><child><object class="GtkSpinButton" id="herb_max"><property name="visible">True</property><property name="can-focus">True</property><property name="adjustment">herb_adjustment</property><property name="numeric">True</property><property name="value">30</property></object><packing><property name="left-attach">3</property><property name="top-attach">0</property></packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="tooltip-text" translatable="yes">Max number of skins you\'re willing to find.</property><property name="halign">end</property><property name="margin-bottom">10</property><property name="label" translatable="yes">Max Skins (?)</property>
      </object><packing><property name="left-attach">2</property><property name="top-attach">1</property></packing></child><child><object class="GtkSpinButton" id="skin_max"><property name="visible">True</property><property name="can-focus">True</property><property name="margin-bottom">10</property><property name="adjustment">skin_adjustment</property><property name="numeric">True</property><property name="value">30</property></object><packing><property name="left-attach">3</property><property name="top-attach">1</property>
      </packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="tooltip-text" translatable="yes">Number of extra skins to get before trying to turn them in.</property><property name="margin-start">20</property><property name="margin-bottom">10</property><property name="label" translatable="yes"># of extra skins(?)</property></object><packing><property name="left-attach">4</property><property name="top-attach">1</property>
      </packing></child><child><object class="GtkSpinButton" id="extra_skin"><property name="visible">True</property><property name="can-focus">True</property><property name="margin-bottom">10</property><property name="text" translatable="yes">30</property><property name="adjustment">extra_skin_adjustment</property><property name="numeric">True</property></object><packing><property name="left-attach">5</property><property name="top-attach">1</property></packing></child><child><placeholder/></child><child><placeholder/>
      </child></object></child><child type="label"><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="label" translatable="yes">Task Limits</property></object></child></object><packing><property name="expand">False</property><property name="fill">True</property><property name="position">1</property></packing></child><child><object class="GtkFrame"><property name="visible">True</property><property name="can-focus">False</property><property name="border-width">10</property><property name="label-xalign">0</property><child><!-- n-columns=4 n-rows=5 --><object class="GtkGrid"><property name="visible">True</property><property name="can-focus">False</property><property name="margin-top">5</property><property name="margin-bottom">5</property><property name="row-spacing">5</property><property name="column-spacing">5</property><child><object class="GtkCheckButton" id="exp_pause"><property name="label" translatable="yes">Rest when mind full</property><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">start</property><property name="margin-start">5</property><property name="draw-indicator">True</property>
      </object><packing><property name="left-attach">0</property><property name="top-attach">0</property></packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="halign">end</property><property name="margin-start">50</property><property name="margin-end">5</property><property name="label" translatable="yes">Selling Script:</property></object><packing><property name="left-attach">2</property><property name="top-attach">0</property><property name="height">2</property>
      </packing></child><child><object class="GtkEntry" id="selling_script"><property name="visible">True</property><property name="can-focus">True</property><property name="valign">center</property><property name="margin-end">10</property><property name="max-width-chars">40</property><property name="placeholder-text" translatable="yes">Defaults to eloot</property></object><packing><property name="left-attach">3</property><property name="top-attach">0</property><property name="height">2</property></packing>
      </child><child><object class="GtkCheckButton" id="only_required_creatures"><property name="label" translatable="yes">Only hunt required creatures</property><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="tooltip-text" translatable="yes">When checked this will limit creature targets to only those necessary to complete the bounty.</property><property name="halign">start</property><property name="margin-start">5</property><property name="draw-indicator">True</property>
      </object><packing><property name="left-attach">0</property><property name="top-attach">1</property></packing></child><child><object class="GtkCheckButton" id="once_and_done"><property name="label" translatable="yes">Run one bounty and quit</property><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="tooltip-text" translatable="yes">When checked this will quit after one bounty.</property><property name="halign">start</property><property name="margin-start">5</property><property name="draw-indicator">True</property>
      </object><packing><property name="left-attach">1</property><property name="top-attach">1</property></packing></child><child><object class="GtkCheckButton" id="rest_random"><property name="label" translatable="yes">Rest at random nodes in town</property><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="tooltip-text" translatable="yes">When checked this will rest in a random node within town. 
      Default is town center.</property><property name="halign">start</property><property name="margin-start">5</property><property name="draw-indicator">True</property>
      </object><packing><property name="left-attach">0</property><property name="top-attach">2</property></packing></child><child><object class="GtkCheckButton" id="use_vouchers"><property name="label" translatable="yes">Use Vouchers</property><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">start</property><property name="margin-start">5</property><property name="draw-indicator">True</property></object><packing><property name="left-attach">1</property><property name="top-attach">0</property>
      </packing></child><child><placeholder/></child><child><placeholder/></child><child><placeholder/></child><child><placeholder/></child><child><placeholder/></child><child><placeholder/></child><child><placeholder/></child><child><placeholder/></child><child><placeholder/></child><child><placeholder/></child><child><placeholder/></child></object></child><child type="label"><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="label" translatable="yes">Misc</property>
      </object></child></object><packing><property name="expand">False</property><property name="fill">True</property><property name="position">1</property></packing></child></object></child></object></child></object></child><child type="tab"><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="label" translatable="yes">General</property></object><packing><property name="tab-fill">False</property></packing></child><child><object class="GtkScrolledWindow"><property name="visible">True</property><property name="can-focus">True</property><property name="shadow-type">in</property><child><object class="GtkViewport"><property name="visible">True</property><property name="can-focus">False</property><child><object class="GtkBox"><property name="visible">True</property><property name="can-focus">False</property><property name="orientation">vertical</property><child><object class="GtkFrame"><property name="visible">True</property><property name="can-focus">False</property><property name="margin-top">6</property><property name="border-width">10</property><property name="label-xalign">0</property><child><!-- n-columns=9 n-rows=9 --><object class="GtkGrid"><property name="visible">True</property><property name="can-focus">False</property><property name="margin-top">5</property><property name="margin-bottom">5</property><property name="row-spacing">20</property><property name="column-spacing">5</property><property name="row-homogeneous">True</property><property name="column-homogeneous">True</property><child><object class="GtkCheckButton" id="escort_types:landing_to_illy"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property>
      </object><packing><property name="left-attach">6</property><property name="top-attach">2</property></packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="label" translatable="yes">Destination </property></object><packing><property name="left-attach">1</property><property name="top-attach">0</property><property name="width">7</property></packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="halign">center</property><property name="label" translatable="yes">Icemule</property>
      </object><packing><property name="left-attach">1</property><property name="top-attach">4</property></packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="halign">center</property><property name="label" translatable="yes">Solhaven</property></object><packing><property name="left-attach">1</property><property name="top-attach">3</property></packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="halign">center</property><property name="label" translatable="yes">Wehnimer\'s</property>
      </object><packing><property name="left-attach">1</property><property name="top-attach">2</property></packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="label" translatable="yes">Start From</property><property name="angle">90</property></object><packing><property name="left-attach">0</property><property name="top-attach">2</property><property name="height">7</property></packing></child><child><object class="GtkCheckButton" id="escort_types:vaalor_to_landing"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property>
      </object><packing><property name="left-attach">2</property><property name="top-attach">7</property></packing></child><child><object class="GtkCheckButton" id="escort_types:illy_to_landing"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property></object><packing><property name="left-attach">2</property><property name="top-attach">6</property>
      </packing></child><child><object class="GtkCheckButton" id="escort_types:zul_to_landing"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property></object><packing><property name="left-attach">2</property><property name="top-attach">5</property></packing></child><child><object class="GtkCheckButton" id="escort_types:icemule_to_landing"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property>
      </object><packing><property name="left-attach">2</property><property name="top-attach">4</property></packing></child><child><object class="GtkCheckButton" id="escort_types:solhaven_to_landing"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property></object><packing><property name="left-attach">2</property><property name="top-attach">3</property>
      </packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="label" translatable="yes">--</property></object><packing><property name="left-attach">2</property><property name="top-attach">2</property></packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="halign">center</property><property name="label" translatable="yes">Zul Logoth</property>
      </object><packing><property name="left-attach">1</property><property name="top-attach">5</property></packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="halign">center</property><property name="label" translatable="yes">Ta\'llistim</property></object><packing><property name="left-attach">1</property><property name="top-attach">6</property></packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="halign">center</property><property name="label" translatable="yes">Ta\'Vaalor</property>
      </object><packing><property name="left-attach">1</property><property name="top-attach">7</property></packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="halign">center</property><property name="label" translatable="yes">Wehnimer\'s</property></object><packing><property name="left-attach">2</property><property name="top-attach">1</property></packing></child><child><object class="GtkCheckButton" id="escort_types:vaalor_to_solhaven"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property>
      </object><packing><property name="left-attach">3</property><property name="top-attach">7</property></packing></child><child><object class="GtkCheckButton" id="escort_types:illy_to_solhaven"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property></object><packing><property name="left-attach">3</property><property name="top-attach">6</property>
      </packing></child><child><object class="GtkCheckButton" id="escort_types:zul_to_solhaven"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property></object><packing><property name="left-attach">3</property><property name="top-attach">5</property></packing></child><child><object class="GtkCheckButton" id="escort_types:icemule_to_solhaven"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property>
      </object><packing><property name="left-attach">3</property><property name="top-attach">4</property></packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="label" translatable="yes">--</property></object><packing><property name="left-attach">3</property><property name="top-attach">3</property></packing></child><child><object class="GtkCheckButton" id="escort_types:landing_to_solhaven"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property>
      </object><packing><property name="left-attach">3</property><property name="top-attach">2</property></packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="halign">center</property><property name="label" translatable="yes">Solhaven</property></object><packing><property name="left-attach">3</property><property name="top-attach">1</property></packing></child><child><object class="GtkCheckButton" id="escort_types:vaalor_to_icemule"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property>
      </object><packing><property name="left-attach">4</property><property name="top-attach">7</property></packing></child><child><object class="GtkCheckButton" id="escort_types:illy_to_icemule"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property></object><packing><property name="left-attach">4</property><property name="top-attach">6</property>
      </packing></child><child><object class="GtkCheckButton" id="escort_types:zul_to_icemule"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property></object><packing><property name="left-attach">4</property><property name="top-attach">5</property></packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="label" translatable="yes">--</property>
      </object><packing><property name="left-attach">4</property><property name="top-attach">4</property></packing></child><child><object class="GtkCheckButton" id="escort_types:solhaven_to_icemule"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property></object><packing><property name="left-attach">4</property><property name="top-attach">3</property>
      </packing></child><child><object class="GtkCheckButton" id="escort_types:landing_to_icemule"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property></object><packing><property name="left-attach">4</property><property name="top-attach">2</property></packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="halign">center</property><property name="label" translatable="yes">Icemule</property>
      </object><packing><property name="left-attach">4</property><property name="top-attach">1</property></packing></child><child><object class="GtkCheckButton" id="escort_types:vaalor_to_zul"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property></object><packing><property name="left-attach">5</property><property name="top-attach">7</property>
      </packing></child><child><object class="GtkCheckButton" id="escort_types:illy_to_zul"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property></object><packing><property name="left-attach">5</property><property name="top-attach">6</property></packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="label" translatable="yes">--</property>
      </object><packing><property name="left-attach">5</property><property name="top-attach">5</property></packing></child><child><object class="GtkCheckButton" id="escort_types:icemule_to_zul"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property></object><packing><property name="left-attach">5</property><property name="top-attach">4</property>
      </packing></child><child><object class="GtkCheckButton" id="escort_types:solhaven_to_zul"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property></object><packing><property name="left-attach">5</property><property name="top-attach">3</property></packing></child><child><object class="GtkCheckButton" id="escort_types:landing_to_zul"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property>
      </object><packing><property name="left-attach">5</property><property name="top-attach">2</property></packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="halign">center</property><property name="label" translatable="yes">Zul Logoth</property></object><packing><property name="left-attach">5</property><property name="top-attach">1</property></packing></child><child><object class="GtkCheckButton" id="escort_types:vaalor_to_illy"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property>
      </object><packing><property name="left-attach">6</property><property name="top-attach">7</property></packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="label" translatable="yes">--</property></object><packing><property name="left-attach">6</property><property name="top-attach">6</property></packing></child><child><object class="GtkCheckButton" id="escort_types:zul_to_illy"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property>
      </object><packing><property name="left-attach">6</property><property name="top-attach">5</property></packing></child><child><object class="GtkCheckButton" id="escort_types:icemule_to_illy"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property></object><packing><property name="left-attach">6</property><property name="top-attach">4</property>
      </packing></child><child><object class="GtkCheckButton" id="escort_types:solhaven_to_illy"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property></object><packing><property name="left-attach">6</property><property name="top-attach">3</property></packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="halign">center</property><property name="label" translatable="yes">Ta\'llistim</property>
      </object><packing><property name="left-attach">6</property><property name="top-attach">1</property></packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="label" translatable="yes">--</property></object><packing><property name="left-attach">7</property><property name="top-attach">7</property></packing></child><child><object class="GtkCheckButton" id="escort_types:illy_to_vaalor"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property>
      </object><packing><property name="left-attach">7</property><property name="top-attach">6</property></packing></child><child><object class="GtkCheckButton" id="escort_types:zul_to_vaalor"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property></object><packing><property name="left-attach">7</property><property name="top-attach">5</property>
      </packing></child><child><object class="GtkCheckButton" id="escort_types:icemule_to_vaalor"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property></object><packing><property name="left-attach">7</property><property name="top-attach">4</property></packing></child><child><object class="GtkCheckButton" id="escort_types:solhaven_to_vaalor"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property>
      </object><packing><property name="left-attach">7</property><property name="top-attach">3</property></packing></child><child><object class="GtkCheckButton" id="escort_types:landing_to_vaalor"><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">False</property><property name="halign">center</property><property name="draw-indicator">True</property></object><packing><property name="left-attach">7</property><property name="top-attach">2</property>
      </packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="halign">center</property><property name="label" translatable="yes">Ta\'Vaalor</property></object><packing><property name="left-attach">7</property><property name="top-attach">1</property></packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property></object><packing><property name="left-attach">8</property><property name="top-attach">1</property>
      </packing></child><child><placeholder/></child><child><placeholder/></child><child><placeholder/></child><child><placeholder/></child><child><placeholder/></child><child><placeholder/></child><child><placeholder/></child><child><placeholder/></child><child><placeholder/></child><child><placeholder/></child><child><placeholder/></child><child><placeholder/></child><child><placeholder/></child><child><placeholder/></child><child><placeholder/></child><child><placeholder/></child><child><placeholder/>
      </child><child><placeholder/></child></object></child><child type="label"><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="label" translatable="yes">Travel Preferances</property></object></child></object><packing><property name="expand">False</property><property name="fill">True</property><property name="position">0</property></packing></child></object></child></object></child></object><packing><property name="position">1</property>
      </packing></child><child type="tab"><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="label" translatable="yes">Escort</property></object><packing><property name="position">1</property><property name="tab-fill">False</property></packing></child><child><object class="GtkScrolledWindow"><property name="visible">True</property><property name="can-focus">True</property><property name="shadow-type">in</property><child><object class="GtkViewport"><property name="visible">True</property><property name="can-focus">False</property><child><object class="GtkBox"><property name="visible">True</property><property name="can-focus">False</property><property name="orientation">vertical</property><child><object class="GtkFrame"><property name="visible">True</property><property name="can-focus">False</property><property name="border-width">10</property><property name="label-xalign">0</property><child><!-- n-columns=3 n-rows=2 --><object class="GtkGrid"><property name="visible">True</property><property name="can-focus">False</property><property name="valign">center</property><property name="margin-top">5</property><property name="margin-bottom">5</property><property name="row-spacing">2</property><property name="column-spacing">5</property><child><object class="GtkButton" id="creature_exclude_add"><property name="label" translatable="yes">Add</property><property name="width-request">80</property><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">True</property><property name="halign">start</property><property name="margin-start">5</property><property name="margin-bottom">5</property>
      </object><packing><property name="left-attach">0</property><property name="top-attach">0</property></packing></child><child><object class="GtkButton" id="creature_exclude_delete"><property name="label" translatable="yes">Delete</property><property name="width-request">80</property><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">True</property><property name="halign">end</property><property name="margin-end">5</property><property name="margin-bottom">5</property>
      </object><packing><property name="left-attach">2</property><property name="top-attach">0</property></packing></child><child><object class="GtkEntry" id="creature_exclude_entry"><property name="width-request">218</property><property name="visible">True</property><property name="can-focus">True</property><property name="halign">start</property><property name="margin-bottom">5</property><property name="hexpand">True</property><property name="placeholder-text" translatable="yes">Critters you don\'t want bounties for</property>
      </object><packing><property name="left-attach">1</property><property name="top-attach">0</property></packing></child><child><object class="GtkScrolledWindow"><property name="height-request">80</property><property name="visible">True</property><property name="can-focus">True</property><property name="hexpand">True</property><property name="border-width">5</property><property name="shadow-type">in</property><child><object class="GtkViewport"><property name="visible">True</property><property name="can-focus">False</property><child><object class="GtkTreeView" id="creature_exclude"><property name="visible">True</property><property name="can-focus">True</property><property name="model">creature_exclude_store</property><property name="headers-visible">False</property><property name="search-column">0</property><property name="fixed-height-mode">True</property><child internal-child="selection"><object class="GtkTreeSelection"/>
      </child><child><object class="GtkTreeViewColumn"><property name="sizing">fixed</property><property name="title" translatable="yes">Exclusion</property><child><object class="GtkCellRendererText"/><attributes><attribute name="text">0</attribute></attributes></child></object></child></object></child></object></child></object><packing><property name="left-attach">0</property><property name="top-attach">1</property><property name="width">3</property></packing></child></object></child><child type="label"><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="tooltip-text" translatable="yes">Exclusions should be entered one line at a time. Regular expressions are supported.

      </property><property name="label" translatable="yes">Creature Exclusions (?)</property>
      </object></child></object><packing><property name="expand">False</property><property name="fill">True</property><property name="position">0</property></packing></child><child><object class="GtkFrame"><property name="visible">True</property><property name="can-focus">False</property><property name="border-width">10</property><property name="label-xalign">0</property><child><!-- n-columns=2 n-rows=2 --><object class="GtkGrid"><property name="visible">True</property><property name="can-focus">False</property><property name="row-homogeneous">True</property><property name="column-homogeneous">True</property><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="tooltip-text" translatable="yes">This profile will be used for gem bounties or if waiting on a bounty.</property><property name="label" translatable="yes">Default Profile(?)</property>
      </object><packing><property name="left-attach">0</property><property name="top-attach">0</property></packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property></object><packing><property name="left-attach">1</property><property name="top-attach">1</property></packing></child><child><object class="GtkComboBoxText" id="default_profile"><property name="visible">True</property><property name="can-focus">False</property><property name="margin-start">10</property><property name="margin-bottom">10</property><property name="has-entry">True</property><child internal-child="entry"><object class="GtkEntry" id="profile_name"><property name="can-focus">True</property><property name="margin-start">10</property>
      </object></child></object><packing><property name="left-attach">0</property><property name="top-attach">1</property></packing></child><child><placeholder/></child></object></child><child type="label"><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="label" translatable="yes">Profile</property></object></child></object><packing><property name="expand">False</property><property name="fill">True</property><property name="position">1</property>
      </packing></child><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="halign">start</property><property name="margin-start">10</property><property name="margin-top">10</property><property name="label" translatable="yes">EBounty uses bigshot profiles.
      It will look for the correct critter in the &lt;valid targets&gt;setting in bigshot
      The resting room must be in the town you are running bounties from
      The starting room ID must be in the location of the bounty.
      For example: If you are asked to cull lesser orcs in Upper Trollfang, then the starting room ID must be in Upper Trollfang.

      Also, the pre-rest commands and active resting scripts of the default profile will be used at the end of each bounty.</property>
      </object><packing><property name="expand">False</property><property name="fill">True</property><property name="position">2</property></packing></child></object></child></object></child></object><packing><property name="position">2</property></packing></child><child type="tab"><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="label" translatable="yes">The Rest</property></object><packing><property name="position">2</property><property name="tab-fill">False</property>
      </packing></child></object><packing><property name="expand">False</property><property name="fill">True</property><property name="position">0</property></packing></child><child><object class="GtkBox"><property name="visible">True</property><property name="can-focus">False</property><child><object class="GtkLabel"><property name="visible">True</property><property name="can-focus">False</property><property name="margin-start">10</property><property name="margin-top">5</property><property name="margin-bottom">5</property><property name="label" translatable="yes">Your changes are saved automatically.</property><attributes><attribute name="style" value="italic"/>
      </attributes></object><packing><property name="expand">False</property><property name="fill">True</property><property name="position">0</property></packing></child><child><object class="GtkButton"><property name="label" translatable="yes">Close</property><property name="width-request">80</property><property name="visible">True</property><property name="can-focus">True</property><property name="receives-default">True</property><property name="halign">end</property><property name="margin-end">10</property><property name="margin-top">5</property><property name="margin-bottom">5</property><property name="hexpand">True</property><signal name="clicked" handler="on_close_clicked" swapped="no"/>
      </object><packing><property name="expand">False</property><property name="fill">True</property><property name="position">1</property></packing></child></object><packing><property name="expand">False</property><property name="fill">True</property><property name="pack-type">end</property><property name="position">2</property></packing></child></object></child></object></interface>'
               
    end
    
    # This is connected to automatically during load_settings and syncs data back to CharSettings.
    def on_update(obj)
      Gtk.queue do
        key = obj.builder_name.to_sym
        setting = Setup.get_setting(key)
        return if setting.nil?

        if obj.class == Gtk::CheckButton
          @settings[key] = obj.active?
        elsif obj.class == Gtk::Entry
          @settings[key] = obj.text.strip
        elsif obj.class == Gtk::SpinButton
          # update from text entry
          obj.update

          # force int, we don't use floats anywhere
          @settings[key] = obj.adjustment.value.to_i
        elsif obj.class == Gtk::ComboBoxText
          @settings[key] = obj.active_text
        end
      end
    end

    def on_close_clicked
      EBounty.save_profile()
      self['main'].destroy
    end

    def on_destroy
      Gtk.queue { @running = false }
    end

    def on_drop_load 

        dir = "#{$data_dir}#{XMLData.game}/#{Char.name}/bigshot_profiles"   
    
        self['default_profile'].remove_all
        self['default_profile'].append_text('')
        names = []
        Dir.foreach(dir){|f| names.push(f)} 
        names.each{ |filename|
          next if filename == '.' || filename == '..'               
          self['default_profile'].append_text("#{filename.sub(".yaml", "")}")
        }     
    end

    # iterate all objects and for any that match a setting name directly we set the default
    def load_settings
      Gtk.queue do
        # load up the generic settings which are just matching by name of the widget
        objects.each do |obj|
          next unless obj.methods.include?(:builder_name)

          key = obj.builder_name.to_sym
          next if (setting = Setup.get_setting(key)).nil?

          # set the default value
          if obj.class == Gtk::CheckButton
            obj.active = @settings[key]
            obj.signal_connect('toggled') { on_update(obj) }
          elsif obj.class == Gtk::Entry
            obj.text = @settings[key].strip
                      
            if obj.builder_name.to_s == "profile_name"
              obj.text = @settings[:default_profile]
            end
          
            obj.signal_connect('changed') { on_update(obj) }
          elsif obj.class == Gtk::SpinButton
            obj.value = @settings[key]
            obj.adjustment.value = @settings[key]
            obj.signal_connect('changed') { on_update(obj) }
          elsif obj.class == Gtk::ComboBoxText 

            if obj.builder_name.to_s == "default_profile"
              on_drop_load  
            end
          
            obj.signal_connect('changed') { on_update(obj) }
          elsif obj.class == Gtk::TreeView
            if (store = self["#{key}_store"]).nil?
              respond "** failed to find store for treeview #{key}"
              next
            elsif setting[:load].nil?
              respond "** no :load defined #{key}"
              next
            end

            setting[:load].call(store, @settings[key])

            # setup the signals
            if (add = self["#{key}_add"]).nil?
              respond "** failed to find add for treeview #{key}"
              next
            elsif (delete = self["#{key}_delete"]).nil?
              respond "** failed to find delete for treeview #{key}"
              next
            elsif (entry = self["#{key}_entry"]).nil?
              respond "** failed to find entry for treeview #{key}"
              next
            end

            add.signal_connect('clicked') do
              if setting[:set].nil?
                respond "** no :set defined for #{key}"
                next
              elsif entry.text.empty?
                next
              end
              setting[:set].call(store, entry.text, @settings[key])
              setting[:load].call(store, @settings[key])
            end

            delete.signal_connect('clicked') do
              if setting[:delete].nil?
                respond "** no :delete defined for #{key}"
                next
              elsif (selected = obj.selection.selected).nil?
                next
              end
              setting[:delete].call(store, selected, @settings[key])
              setting[:load].call(store, @settings[key])
            end
          end
        end

        # checkboxes for array storage with id's <setting>:<value>
        # this is primarily used by the loot types
        objects.each do |obj|
          next unless obj.methods.include?(:builder_name)
          next unless obj.builder_name =~ /^([^:]+):(.*)$/i
          next unless obj.class == Gtk::CheckButton

          key = Regexp.last_match(1).to_sym
          value = Regexp.last_match(2).to_s
          next if Setup.get_setting(key).nil?

          obj.active = @settings[key].include?(value)

          # add in hook
          obj.signal_connect('toggled') do
            @settings[key].delete(value)
            if obj.active?
              @settings[key].push(value)
              @settings[key].uniq!.sort!
            end
          end
        end
      end
    end

    def start
      @running = true

      Gtk.queue { self['main'].show_all }

      wait_while { @running }
    end

    def list(cat_to_list: 'all')
      indent_size = 2
      print_array =
        proc do |key, value, indent|
          _respond("#{' ' * indent_size * indent.to_i}#{key}:")
          value.sort!.each { |entry| _respond("#{' ' * indent_size * (indent.to_i + 1)}#{value.index(entry) + 1}. #{entry}") }
        end

      print_value = proc { |key, value, indent| _respond("#{' ' * indent_size * indent.to_i}#{key}: #{value}") }

      categories = cat_to_list == 'all' ? %w[loot sell skin internal] : [cat_to_list]
      if $frontend == 'stormfront'
        output = "<output class=\"mono\"/>\n"
      else
        output = String.new
      end
      categories.each do |opt|
        _respond("#{output}") if !output.empty?
        _respond("#{monsterbold_start}= #{opt.capitalize} =#{monsterbold_end}\n")
        @@categories[opt.to_sym].each do |id, _|
          value = @settings[id]
          value.class == Array ? print_array.call(id, value, 1) : print_value.call(id, value, 1)
        end
      end
      if $frontend == 'stormfront'
        output = "<output class=\"\"/>\n"
        _respond("#{output}")
      end
    end

    def self.update_setting(key, value)
      setting = Setup.get_setting(key)
      EBounty.msg("error", "** Setting \"#{key}\" does not exist") if setting.nil?

      action = nil

      if value =~ /^([+-])(.*)$/
        action = Regexp.last_match(1)
        value = Regexp.last_match(2).strip.downcase
      end

      if value == 'reset'
        @settings.delete(key)
        EBounty.msg("info", " Reset #{key}")
      elsif @settings[key].class == Array
        if value =~ /\d/ && @settings[key][value.to_i]
          @settings[key].delete_at(value.to_i)
        else
          @settings[key].delete(value)
        end

        if action == '-'
          EBounty.msg("info", " \"#{value}\" removed from \"#{key}\"")
        else
          @settings[key].push(value)
          EBounty.msg("info", " \"#{value}\" added to \"#{key}\"")
        end

        EBounty.msg("info", " \"#{key}\" is now \"#{@settings[key].join(', ')}\"")
      else
        if @settings[key].class == FalseClass || @settings[key].class == TrueClass
          value = value =~ /^true|1|yes|on/ ? true : false
        elsif @settings[key].class == Integer
          value = value.to_i
        end

        EBounty.msg("info", " \"#{key}\" has been set to \"#{value}\"")
        @settings[key] = value
      end
    end
  end

  module Hunting
  
    def self.should_hunt?
      
      if percentmana < UserVars.op['rest_till_mana'].to_i
        EBounty.data.reason = "Mana less than #{UserVars.op['rest_till_mana']}"
        return false
      end
      
      if !EBounty.data.wait
        return true
      end
      
      if checkbounty =~ /^You are not currently assigned / && !Spell[9003].active?
        return true
      end
      
      #fixme: convert to actual percentage
      if( percentmind() > 50)
        EBounty.data.reason = "Mind > 50%"
        return false
      elsif( percentmana() < 90 )
        EBounty.data.reason = "Mana < 90%"
        return false
      elsif( checkspirit() < (Stats.aur[0].to_f / 10).round - 1 )
        EBounty.data.reason = "Spirit too low"
        return false
      elsif Stats.enhanced_aur[0].to_i < Stats.aur[0].to_i
        EBounty.data.reason = "Recovering from Death"
        return false
      end      
      return true
    end
  
    def self.set_parameters
    
    
    
    end
  
    def self.go_hunting

      hunt_start = 0
      hunt_end = 0
      converted = nil
     
      original_targets = UserVars.op['targets']
      original_wounded = UserVars.op['wounded_eval']
      original_fried = UserVars.op['fried']
      original_encumbered = UserVars.op['encumbered']
   
      before_dying { 
        Script.kill("bigshot") if Script.running?("bigshot")
      
        UserVars.op['targets'] = original_targets
        UserVars.op['wounded_eval'] = original_wounded
        UserVars.op['fried'] = original_fried
        UserVars.op['encumbered'] = original_encumbered

     
        profile = "#{EBounty.data.dir}/#{EBounty.data.settings[:default_profile]}.yaml"
        UserVars.op = YAML.load_file(profile)
     
      } 
 
    # Tell bigshot when to stop hunting.
      wounded_eval = "XMLData.injuries.any?{|key,value| value['wound'] > 1} || percenthealth <= 80" # low health or wounded
      wounded_eval += " || (checkbounty =~ /^You (?:succeeded|have located)|your task is failed/)" # bounty complete
      wounded_eval += " || (checkbounty =~ /^You have made contact with the child/ && GameObj.npcs.any? { |npc| npc.name =~ /\\bchild\\b/ })" # child found
      wounded_eval += " || (checkbounty =~ /^You are not currently assigned / && !Spell[9003].active?)"
      wounded_eval += " || (checkbounty =~ /You have been tasked to retrieve(.*)of at least/ && (j=0;GameObj.inv.each{|i| j += i.contents.count{|l| l.name =~ /#{EBounty.data.skin}/i}.to_i}; j >= EBounty.data.remaining_skins.to_i))"
      wounded_eval += " || (checkbounty =~ /The gem dealer/ && (t=0;GameObj.inv.each{|k| t += k.contents.count{|v| v.name =~ /#{EBounty.data.gem.strip}/i}.to_i}; t>= EBounty.data.remaining_gems.to_i))"

      UserVars.op['wounded_eval'] = wounded_eval          
      UserVars.op['encumbered'] = "10"
      
      if checkbounty =~ /You are not currently assigned a task/ && Spell[9003].active?
        UserVars.op['fried'] = "100"
      else     
        UserVars.op['fried'] = "101"
      end
  
      if EBounty.data.settings[:only_required_creatures] && !EBounty.data.creature.nil? 
        UserVars.op['targets'] = EBounty.data.creature == "bandits" ? "(?:thief|rogue|bandit|mugger|outlaw|highwayman|marauder|brigand|thug|robber)"   : "(?:grizzled|ancient)?\s?(?:#{EBounty.data.creature})"
      elsif !EBounty.data.settings[:only_required_creatures] && !EBounty.data.creature.nil? && EBounty.data.creature != "bandits" 
        UserVars.op['targets'] += ",(?:grizzled|ancient)?\s?(?:#{EBounty.data.creature})"
      elsif !EBounty.data.settings[:only_required_creatures] && !EBounty.data.creature.nil? && EBounty.data.creature == "bandits" 
        UserVars.op['targets'] += ",(?:thief|rogue|bandit|mugger|outlaw|highwayman|marauder|brigand|thug|robber)"
      end
  
      until checkbounty =~ /succeeded in your task|You have made contact with the child you are to rescue|You have located/i || (checkbounty =~ /You are not currently assigned a task/ && !Effects::Cooldowns.active?("Next Bounty"))
      
        Task.prep
        
        if checkbounty =~ /You have been tasked to retrieve (\d+) (.*?)(?:s)? of at least/
          EBounty.data.remaining_skins = $1.to_i + 1
        elsif checkbounty =~ /You have been tasked to retrieve (\d+) (?:more of|of) them/
          EBounty.data.remaining_gems = $1.to_i
        end
        
        break if checkbounty =~ /succeeded in your task /
                 
        until(Hunting.should_hunt?)
				                           
          Script.run('eherbs') if XMLData.injuries.any? { |a,h| h['wound'] > 0 || percenthealth < 95 || h['scar'] > 0} 

          EBounty.go2_rest
                         
          if EBounty.data.rest_time < Time.now
            respond ""
            respond "Last Hunt: #{converted}" if hunt_start != 0
            respond ""
            respond "Not Hunting: #{EBounty.data.reason}"
            respond ""
                                 
            fput EBounty.data.rest_options.sample					
            #Fixme: self_buffs
           
            EBounty.data.rest_time = Time.now + 30 
          end
          sleep 0.5
        end
      
        break if checkbounty =~ /^You are not currently assigned / && !Spell[9003].active?
      
        hunt_start = Process.clock_gettime(Process::CLOCK_MONOTONIC)
        Script.run('bigshot','bounty') 
        hunt_end = Process.clock_gettime(Process::CLOCK_MONOTONIC)
        elapsed = hunt_end - hunt_start
        converted = Time.at(elapsed).utc.strftime("%H:%M:%S")
        
        #End at the bigshot resting spot so we stay in the same town
        unless GameObj.npcs.find { |n| n.name =~ /child/i }
          #fixme: support for UID
          EBounty.go2(UserVars.op["resting_room_id"]) 
          UserVars.op["resting_commands"].to_a.each { |i| fput(i) } unless UserVars.op["resting_commands"].empty?
        end
      end
      
      UserVars.op['targets'] = original_targets
      UserVars.op['wounded_eval'] = original_wounded
      UserVars.op['fried'] = original_fried
      UserVars.op['encumbered'] = original_encumbered
       
    end
  
  end

  module Task
    
    def self.bounty_check
    
      EBounty.data.creature = nil
    
      bounty_regex = Regexp.union(
        /It appears they have a creature problem they'd like you to solve./,
        /It appears they have a bandit problem they'd like you to solve./,
        /It appears that a local resident urgently needs our help in some matter.  Go report to .* to find out more./,
        /It appears they need your help in tracking down some kind of lost heirloom.  Go report to .* to find out more./
        )
      
      guard_regex = Regexp.union(
        /suppress bandit activity|bandits you encounter/,
        /particularly dangerous|cull their numbers|(?!.*bandit)suppress .* activity/,
        /SEARCH the area|do a thorough SEARCH/,
        /LOOT the item from its corpse/
        )
      
      EBounty.msg("debug","bounty_check: #{checkbounty}")
  
      #bounty status
      if (checkbounty =~ /You are not currently assigned a task./i )
        EBounty.msg("debug","no_bounty")
        Effects::Cooldowns.active?("Next Bounty") ? Task.wait_for_bounty : Task.bounty_get
      elsif (checkbounty =~ /You have succeeded in your task and can return to the Adventurer's Guild to receive your reward./i )
        Task.bounty_complete
      elsif (checkbounty =~ /You succeeded in your task and should report back to/i )
        Task.task_complete("guard")
      
      #get bounty ...
      elsif (checkbounty =~ bounty_regex)
        EBounty.go2("advguard")
        EBounty.go2("advguard2") if !checknpcs.include?("guard") #Fixme: different for RR
        res = dothistimeout "ask guard about bounty", 3, guard_regex
        Task.bounty_check
      elsif (checkbounty =~ /The local healer, .*?, has asked for our aid./)
        Task.forage_ask
        Task.bounty_check
      elsif (checkbounty =~ /The local gem dealer, .*?, has an order to fill and wants our help./)
        Task.gem_ask
        Task.bounty_check
      elsif (checkbounty =~ /The local furrier .*? has an order to fill and wants our help./)
        Task.skin_ask
        Task.bounty_check
      
      #child bounty
      elsif (checkbounty =~ /A local divinist has had visions of the child fleeing from an? ((?:\w+|\s|'){1,5}) (?:in|on|near) (?:(.*) (?:under|near|between) )?([^.]+)\.  Find the area/i )
        Task.child_bounty($1,$2)
      
      #bandit/creature bounty	
      elsif (checkbounty =~ /You have been tasked to suppress bandit activity (?:in|on|near) (?:(.*) (?:under|near|between) )?([^.]+)\./ )
        Task.bandit_bounty($1)
      #creature tasks
      elsif (checkbounty =~ /You have been tasked to hunt down and kill a particularly dangerous (.*) that has established a territory (?:in|on|near) (?:(.*) (?:under|near|between) )?([^.]+)\./i )
        location = $2.nil? ? $3 : $2
        Task.creature_culling($1,location,"grizzled")
      elsif checkbounty =~ /You have been tasked to suppress (.*) activity (?:in|on|near) (?:(.*) (?:under|near|between) )?([^.]+)\.  You need to kill (\d+) (?:more )?of them to complete your task\./i
        Task.creature_culling($1, $2, "herd")
      #forage bounty
      elsif (checkbounty =~ /The .* in ([^,]+), [^,]+, is working on a concoction that requires (?:a|an|some) (.*) found (?:in|on|near) (?:(.*) (?:under|near|between)) ?([^.]+)\..*You have been tasked to retrieve (\d+)/i )
        Task.forage_bounty($2,$3,$5)      
      #gem bounty
      elsif (checkbounty =~ /The gem dealer in .*, .*, has received orders from multiple customers requesting (.*).  You have been tasked to retrieve (\d+) (?:more of|of) them.  You can SELL them to the gem dealer as you find them./i )
        Task.gem_bounty($1,$2)      
      #skin bounty  
      elsif (checkbounty =~ /You have been tasked to retrieve (\d+) (.*?)(?:s)? of at least \w+ quality for .*? in .*?.  You can SKIN them off the corpse of (?:a|an) (.*?) or purchase them from another adventurer./i )
        Task.skin_bounty($3,$2,$1)     
      #heirloom bounty
      elsif (checkbounty =~ /You have been tasked to recover (?:an?|some) (.*) that an unfortunate citizen lost after being attacked by an? ((?:\w+|\s|'){1,4}) (?:in|on|near) (?:(.*) (?:under|near|between) )?([^.]+)\.  .*(SEARCH|LOOT)/i )
        Task.heirloom_bounty($1, $2, $3, $5)
      #escort bounty
      elsif (checkbounty =~ /client has hired us to provide a protective escort .* Go to the (.*?) and WAIT .* guarantee .*? safety to (.*?) as soon as you can/i)
        Task.escort($1,$2)
      elsif (checkbounty =~ /You have located (?:a |an )?(.*?) and should bring it back to .*? of .*?./i )
        Task.task_complete("heirloom",$1) 
      elsif (checkbounty =~ /You have failed in your task/i)
        Task.task_failed
      #no match
      else
        EBounty.msg("warn", "Unknown Result: Unable to match bounty_check.")
      end
      
    end
  
    def self.bandit_bounty(location)
      EBounty.msg("debug","bandit_bounty | location: #{location}")
    
      if EBounty.data.settings[:bounty_types].include?("kill_bandits")
        EBounty.data.wait = false
        EBounty.switch_profile("bandits",location)     
        Task.prep       
        Hunting.go_hunting       
        Task.bounty_check
      else
        Task.bounty_remove
      end  
    end
  
    def self.bounty_complete     
      EBounty.msg("debug","bounty_complete")
      
      #Make sure the default profile is loaded
      profile = "#{EBounty.data.dir}/#{EBounty.data.settings[:default_profile]}.yaml"
      UserVars.op = YAML.load_file(profile)
      
      #EBounty.go2(UserVars.op["resting_room_id"])     
      
      if checkmind == "saturated"
        Task.prep
        EBounty.go2_rest 
      end
            
      #Hang out until not satuarated
      until checkmind != "saturated"
        sleep 30
        fput EBounty.data.rest_options.sample					
        #Fixme: self_buffs    
      end
    
      #Go over to the adventure guild
      advguild_id = Room[Room[UserVars.op["resting_room_id"]].find_nearest_by_tag("advguild")].id 
      EBounty.go2(advguild_id)
      
      #Turn in the bounty - Fixme: dothistimeout
      fput "ask task about bounty"
      sleep 3
      
      #Reset waiting flag for hunting
      EBounty.data.wait = true
      
      Task.prep
      
      #Lets get a bounty
      Task.bounty_check
             
    end
  
    def self.bounty_get   
      EBounty.msg("debug","bounty_get")
      
      advguild_id = Room[Room[UserVars.op["resting_room_id"]].find_nearest_by_tag("advguild")].id 
      EBounty.go2(advguild_id)
      
      res = dothistimeout "ask task about bounty", 3, Regexp.union(
        /The local gem dealer, .*, has an order to fill and wants our help./,
        /The local furrier .* has an order to fill and wants our help./,
        /It appears they have a .* problem they'd like you to solve./,
        /It appears that a local resident urgently needs our help in some matter.  Go report to .* to find out more./,
        /The local healer, .*, has asked for our aid./,
        /You have already been assigned a task, \w+./,
        /It appears they need your help in tracking down some kind of lost heirloom.  Go report to .* to find out more./,
        /Come back in about .* (?:minute|minutes) if you want another task./
        )
        
      Task.bounty_check
    end
    
    def self.bounty_remove(just_remove = false)
      EBounty.msg("debug","bounty_remove")

      EBounty.go2("advguild")    
      until checkbounty =~ /You are not currently assigned a task/
        fput "ask ##{GameObj.npcs.find{|npc| npc.name =~ /#{checknpcs.last}/}.id} about removal"
        EBounty.wait_rt
      end
      
      return if just_remove
          
      if EBounty.data.settings[:use_vouchers]
        advguild_id = Room[Room[UserVars.op["resting_room_id"]].find_nearest_by_tag("advguild")].id 
        EBounty.go2(advguild_id)
        fput "ask ##{GameObj.npcs.find{|npc| npc.name =~ /#{checknpcs.last}/}.id} about expediting"
        EBounty.wait_rt
      end

      Task.bounty_check
    end
     
    def self.child_bounty(critter, location)
      EBounty.msg("debug","child_bounty | critter: #{critter} location: #{location}")
      
      if EBounty.data.settings[:bounty_types].include?("rescue")
        EBounty.data.wait = false
        EBounty.switch_profile(critter, location)     
        Task.prep       
        Hunting.go_hunting       
        Script.run('echild')  
        Task.bounty_check
      else
        Task.bounty_remove
      end       
    end
        
    def self.creature_culling(critter, location, type)
      EBounty.msg("debug","creature_culling | critter: #{critter} location: #{location} type: #{type}")
   
      if (EBounty.data.settings[:bounty_types].include?("culling") && type == "herd") || (EBounty.data.settings[:bounty_types].include?("boss_creature") && type == "grizzled")
        EBounty.data.wait = false
        EBounty.switch_profile(critter, location)     
        Task.prep        
        Hunting.go_hunting       
        Task.bounty_check
      else
        Task.bounty_remove
      end  
    end
    
    def self.escort(pickup, dropoff)
      EBounty.msg("debug","escort | pickup: #{pickup} dropoff: #{dropoff}")
  
      escort_pickup = {
        "area just inside the Sapphire Gate"                   => "illy",
        "area just inside the North Gate"                      => "landing",
        "south end of North Market"                            => "solhaven",
        "area just north of the South Gate, past the barbican" => "icemule",
        "Kresh'ar Deep monument"                               => "zul",
        "area just inside the Amaranth Gate"                   => "vaalor",
      }
      
      escort_dropoff = {
        "Wehnimer's Landing" => "landing",
        "Icemule Trace"      => "icemule",
        "Zul Logoth"         => "zul",
        "Solhaven"           => "solhaven",
        "Ta'Vaalor"          => "vaalor",
        "Ta'Illistim"        => "illy",
      }
      
      composite = "#{escort_pickup[pickup]}_to_#{escort_dropoff[dropoff]}"
 
      if EBounty.data.settings[:escort_types].include?(composite) && EBounty.data.settings[:bounty_types].include?("escort")
        #Fixme - script checks needed
        Script.run('ego2')  
        Task.bounty_check
      else
        Task.bounty_remove
      end       

    end
    
    def self.forage_ask
      EBounty.msg("debug","forage_ask")
      
      if EBounty.data.settings[:bounty_types].include?("foraging")    
        room = Room[UserVars.op["resting_room_id"]].find_nearest(EBounty.data.herbalist_rooms)        
        EBounty.go2(room)       
        if Room.current.id == 10396
          herbalist = "maraene"
        else
          herbalist = GameObj.npcs.find { |t| t.name =~ /brother Barnstel|scarred Agarnil kris|healer|herbalist|merchant Kelph|famed baker Leaftoe|Akrash|old Mistress Lomara/i }.noun
        end     
        fput "ask #{herbalist} about bounty"
      else
        Task.bounty_remove
      end    
    end
    
    def self.forage_bounty(herb,location,quantity)
      EBounty.msg("debug","forage_bounty: herb - #{herb} location - #{location} quantity - #{quantity}")

      herb = herb.gsub(/^some /, "")
 
      herb = 'ayana leaf' if herb =~ /ayana (weed|lichen|berry|root)/
      herb = "ayana'al leaf" if herb =~ /ayana'al (weed|lichen|berry|root)/
 
      herbs = EBounty.data.sacks["default"].contents.find_all { |i| herb.end_with? i.name || (herb.start_with? tag && herb =~ /ayana/) }
 
      if herbs.length.positive? 
        Task.forage_return
        Task.bounty_check
        return
      end
 
      #Make sure we unload and heal up.
      Task.prep
   
      location_list = []
      Room.list.find_all do |r|
        if r.tags.any? { |tag| herb.end_with? tag || (herb.start_with? tag && herb =~ /ayana/)} && !r.location.nil? && location =~ /#{r.location}/i 
          location_list.push(r.id)
        end
      end
      
      unless location_list.length.positive?
        echo "No #{herb} found at #{location}"
        exit
      end
      #Make sure we are searching for the right thing
      forage_item = nil
      Room[location_list.first].tags.each { |tag|
        if herb.end_with? tag || (herb.start_with? tag && herb =~ /ayana/)
          forage_item = tag
        end
      }
 
      location_list.each { |room|
        
        EBounty.go2(room)
            
        unless checkpcs || checknpcs
          
          until kneeling?
            fput 'kneel'
            sleep 0.2
          end
          
          #fixme use Lich empty hand
          empty_hand
          
          right_hand = GameObj.right_hand
          left_hand = GameObj.left_hand
          
          loop {       
            Spell[506].cast if Spell[506].known? && Spell[506].affordable? && !Spell[506].active?              
            Spell[604].cast if Spell[604].known? && Spell[604].affordable? && !Spell[604].active?              
         
            forage_result = dothistimeout "forage for #{forage_item}", 10, /^You forage|^You make so much noise that only the dead would not notice you thrashing about in your unsuccessful search\.$|^You stumble about in a fruitless attempt at foraging\.$|you are unable to find anything useful|^As you carefully forage around you (can find no hint|see no evidence) of what you are looking for(?: right now, though you are fairly certain this is where it can be found)?\.|^You begin to forage around when your hand comes into contact with something that stabs you in the finger\.$|^As you forage around you suddenly feel a sharp pain in your right hand!|^You begin to forage around when suddenly you feel a burning sensation in your hand\.$|^You fumble about so badly in your search that you can only hope no one was watching you\.$/
            EBounty.wait_rt
            if forage_result =~ /^You forage briefly and manage to find/
            
              #hands_free() Fixme
              fput "stow left" if GameObj.left_hand.name != "Empty" && GameObj.left_hand != left_hand
              fput "stow right" if GameObj.right_hand.name != "Empty" && GameObj.right_hand != right_hand
 
              break if EBounty.data.sacks["default"].contents.find_all { |i| i.name =~ /#{forage_item}/ }.length >= quantity.to_i
              
             #Fixme: Consolidate damage regex 
            elsif forage_result =~ /^You begin to forage around when your hand comes into contact with something that stabs you in the finger./
              EBounty.wait_rt
              Spell[114].cast if Spell[114].known? and Spell[114].affordable?
            elsif forage_result =~ /^As you forage around you suddenly feel a sharp pain in your right hand|suddenly you feel a burning sensation in your hand/
              EBounty.wait_rt
              Spell[114].cast if Spell[114].known? && Spell[114].affordable?               
            elsif forage_result.nil?  or (forage_result =~ /^As you carefully forage around you (can find no hint|see no evidence) of what you are looking for(?: right now, though you are fairly certain this is where it can be found)?\.|As you forage around, you notice that someone has been foraging here recently and you are unable to find anything useful/)
              break
            end
            
            if XMLData.injuries.any? { |a,h| h['wound'] > 0 || h['scar'] > 0} || percenthealth < 90 
              return_room = Room.current.id
              EBounty.go2(UserVars.op["resting_room_id"])
              Task.prep
              EBounty.go2(return_room)
            end
            
            break if checknpcs
            
          }
                  
          fput 'stand' until standing?
          
          fill_hand
          
          break if EBounty.data.sacks["default"].contents.find_all { |i| i.name =~ /#{forage_item}/ }.length >= quantity.to_i
          
        end
      }
      
      Task.forage_return
      
      Task.bounty_check
   
    end
    
    def self.forage_return
      EBounty.msg("debug","forage_return")
      room = Room[UserVars.op["resting_room_id"]].find_nearest(EBounty.data.herbalist_rooms)
      
      EBounty.go2(room)
      
      if Room.current.id == 10396
        herbalist = "maraene"
      else
        herbalist = GameObj.npcs.find { |t| t.name =~ /brother Barnstel|scarred Agarnil kris|healer|herbalist|merchant Kelph|famed baker Leaftoe|Akrash|old Mistress Lomara/i }.noun
      end
      
      if checkbounty =~ /The.*is working on a concoction that requires (?:a|an|some) (.*) found/     
        herb = $1
      end
      
      herbs = EBounty.data.sacks["default"].contents.find_all { |i| i.name =~ /#{herb}/ }

      fput "store all" if checkleft or checkright
      fput "stow all" if checkleft or checkright

      herbs.each do |h|
        fput "_drag ##{h.id} right"
        res = dothistimeout("give ##{h.id} to #{herbalist}", 3, /This looks perfect|That looks like it has been partially used up/)

        #Fixme - check if hand empty before stowing
        if res !~ /perfect/
          fput "stow ##{h.id}"
        end
      end
      EBounty.msg("debug","forage_return: checkbounty - #{checkbounty}")
      sleep 3
      EBounty.msg("debug","forage_return: checkbounty - #{checkbounty} after 3")
      if checkbounty =~ /The.*is working on a concoction that requires (?:a|an|some) (.*) found/
        EBounty.go2_rest
        EBounty.msg("info","Didn't finish foraging task. Sleeping 3 minutes to let the room recover")
        sleep 180
      end
    
    end
    
    def self.gem_ask
      EBounty.msg("debug","gem_ask")
      
      if EBounty.data.settings[:bounty_types].include?("gem_collecting")       
        EBounty.go2("gemshop")
        if Room.current.id == 10327
          npc = "areacne"
        else
          npc = GameObj.npcs.find { |t| t.name =~ /dwarven clerk|gem dealer|jeweler|Zirconia/i }
        end
        dothistimeout("ask #{npc} about bounty", 5, /Yes, I do have a task for you/)
      else
        Task.bounty_remove
      end       
    end
    
    def self.gem_bounty(kind = nil, amount = nil)
      EBounty.msg("debug","gem_bounty")
      #eventually use kind and amount for gem hording
      #Fixme: need time limit
     
      EBounty.data.remaining_gems = amount.to_i
      EBounty.data.gem = kind.gsub(/^a/, "")
      EBounty.data.wait = false
     
      profile = "#{EBounty.data.dir}/#{EBounty.data.settings[:default_profile]}.yaml"
      UserVars.op = YAML.load_file(profile)
      
      Task.prep
      
      Hunting.go_hunting
      
      Task.bounty_check
     
    end
    
    def self.heirloom_bounty(item = nil, critter = nil, location = nil, type = nil)      
      EBounty.msg("debug","heirloom_bounty | item: #{item} | critter: #{critter} | location: #{location} | type: #{type}")
   
      if (EBounty.data.settings[:bounty_types].include?("heirloom_loot") && type =~ /loot/i) || (EBounty.data.settings[:bounty_types].include?("heirloom_search") && type =~ /search/i)     
        if type =~ /loot/i
          EBounty.data.wait = false
          EBounty.switch_profile(critter, location)     
          Task.prep        
          Hunting.go_hunting       
          Task.bounty_check
        end
        
        if type =~ /search/i
          Task.heirloom_search(critter,location)
        end
      else
        Task.bounty_remove
      end      
    end
    
    def self.heirloom_search(critter,location) 
    
      EBounty.switch_profile(critter,location) 
      Task.prep
      
      #Fixme: use start up commands?
      fput "gird"
         
      EBounty.go2(UserVars.op['hunting_room_id'])      
      wander_rooms ||= Array.new
      
      #fixme: need to support uid
      boundaries = UserVars.op['hunting_boundaries'].split(",")

      wander = proc {
        room = Room.current
        next_room_options = room.wayto.keys - boundaries
        next_room_options.delete_if { |room_id| (room.timeto[room_id].class == Proc) and room.timeto[room_id].call.nil? }
        next_room = next_room_options.find_all { |r| not wander_rooms.include?(r) }
        if next_room.empty?
          next_room = wander_rooms.find { |r| next_room_options.include?(r) }
        else
          next_room = next_room[rand(next_room.length)]
        end
        wander_rooms.delete(next_room)
        wander_rooms.push(next_room)
        way = room.wayto[next_room]
        if way.class == String 
          move(way)
        else
          way.call
        end
      }
      
      fput "stance defensive"
      
      loop{       
        unless GameObj.npcs        
          fput "kneel" until kneeling?         
          if checkleft or checkright
            empty_hands
          end           
          fput "search"            
          EBounty.wait_rt            
          fput "stand" until standing?            
          EBounty.wait_rt            
          seller = EBounty.data.settings[:selling_script]
          
          #Fixme: use looting script from profile
          if seller.nil? || seller.empty?
            Script.run('eloot')
          else
            Script.run(EBounty.data.settings[:selling_script])
          end                     
          fill_hands
        end
        
        break if checkbounty =~ /You have located/
        
        wander.call
        
      }
    
      Task.bounty_check
    
    
    end
    
    def self.skin_ask
      EBounty.msg("debug","skin_ask")
      
      if EBounty.data.settings[:bounty_types].include?("skinning")     
        EBounty.go2("furrier")    
        npc = GameObj.npcs.find { |t| t.name =~ /dwarven clerk|furrier/i }   
        dothistimeout("ask #{npc} about bounty", 5, /Yes, I do have a task for you/)
      else
        Task.bounty_remove
      end       
    end
    
    def self.skin_bounty(critter,skin,quantity)
      EBounty.msg("debug","skin_bounty")
      #Find the critter
      
      EBounty.skinning_profile(critter)
      
      EBounty.data.wait = false
      skin = skin.strip.downcase.
      gsub(/s$/, "").
      gsub(/teeth/, "tooth").
      gsub(/hooves?/, "hoof").
      gsub(/ruffs?/, "ruff")
    
      EBounty.data.remaining_skins = quantity.to_i + EBounty.data.settings[:extra_skin].to_i
      EBounty.data.skin = skin
      
      Task.prep
      
      Hunting.go_hunting
      
      Task.prep
      
      Task.bounty_check
     
    end
  
    def self.task_complete(who, item = nil)
      EBounty.msg("debug","task_complete")
      if who =~ /guard|heirloom/
        EBounty.go2("advguard")
        EBounty.go2("advguard2") if !checknpcs.include?("guard") #Fixme: different for RR
        
        guard = GameObj.npcs.find { |npc| npc.name =~ /(?:guard|sergeant|guardsman|purser|Belle)$/i }.noun
        
        #Fixme: better lootsack handling
        if item != nil
          obj = EBounty.data.sacks["default"].contents.find { |i| i.name =~ /#{item}/ }
          fput "get ##{obj.id}"
        end
        
        res = dothistimeout("ask #{guard} about bounty", 2, /Ah, so you have returned|You have completed your task/)
        if res.nil?
          respond "Unknown response: #{res}"
        end
      end  
      
      EBounty.wait_rt
      
      if EBounty.data.settings[:once_and_done]
        exit
      end
      
      Task.bounty_check
    
    end
  
    def self.task_failed
      EBounty.msg("debug","task_failed")
            
      advguild_id = Room[Room[UserVars.op["resting_room_id"]].find_nearest_by_tag("advguild")].id 
      EBounty.go2(advguild_id)
      
      #Turn in the bounty - Fixme: dothistimeout
      fput "ask task about bounty"
      sleep 3
      
      #Lets get a bounty
      Task.bounty_check
      
    end
  
    def self.prep
      EBounty.msg("debug","prep")
      #lets make sure we are healed up - Need support for empaths and healing script preferance
      Script.run('eherbs') if XMLData.injuries.any? { |a,h| h['wound'] > 0 || percenthealth < 95 || h['scar'] > 0}  
      
      #Sell stuff
      if EBounty.data.sacks["default"].contents.any? { |item| !item.sellable.nil? || item.type =~ /box/}
        EBounty.sell
      end
    
    end
  
    def self.wait_for_bounty()
      EBounty.msg("debug","wait_for_bounty")
           
      Task.prep     
      EBounty.go2_rest
      
      profile = "#{EBounty.data.dir}/#{EBounty.data.settings[:default_profile]}.yaml"
      UserVars.op = YAML.load_file(profile)
      EBounty.data.wait = true
 
      Hunting.go_hunting
      
      Task.prep
      
      Task.bounty_check
    end
 
  end

end


EBounty.data.settings[:debug] = false


# Initialize default settings
unless EBounty.data
  EBounty.load(EBounty.load_profile())
end

# Default to running bounties
if script.vars[1].nil?
  
  current_settings = UserVars.op
  EBounty.set_variables
  EBounty.bounty_check
  
  before_dying { UserVars.op = current_settings}

  exit
end


case script.vars[1]
when 'help'
  EBounty.help
when 'list'
  EBounty::Setup.new(EBounty.data.settings).list 
when 'setup'
  EBounty::Setup.new(EBounty.data.settings).start
  EBounty.load(EBounty.load_profile())
  EBounty.set_variables
when 'load'
  EBounty.load(EBounty.load_profile)
  EBounty.set_variables
when 'remove'
  EBounty::Task.bounty_remove(true)
when 'test'
  EBounty.test
end




